# Release 1.0.0 Prep Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Clean the repository of internal development artifacts and add automatic README version updates to the release pipeline.

**Architecture:** Three independent work areas — GitHub Issues creation from the future-rule-ideas.md file, git cleanup of internal artifacts, and a new step in release.yml that mirrors the existing CHANGELOG update pattern. No source code changes.

**Tech Stack:** GitHub CLI (`gh`), git, YAML (GitHub Actions), bash sed

---

### Task 1: Create GitHub Issues from future-rule-ideas.md

**Files:**
- Read: `docs/future-rule-ideas.md`

**Context:** The file lists rule ideas at different priority levels. We create GitHub issues only for **actionable** ideas. Skip anything marked "Rejected", "Not actionable as rule", or already covered by existing rules.

The repo is `androidbroadcast/Koin-Detekt`.

**Step 1: Check existing issues to avoid duplicates**

```bash
gh issue list --repo androidbroadcast/Koin-Detekt --limit 50 --state open
```

Look for any existing issues mentioning: ScopedViewComponentLeak, CircularGetDependency, AndroidContextAccessOutsideModuleDefinition, MissingAndroidContextInModuleVerification.

**Step 2: Create issue — ScopedViewComponentLeak**

Only if no existing issue found:

```bash
gh issue create \
  --repo androidbroadcast/Koin-Detekt \
  --title "Rule idea: ScopedViewComponentLeak — detect UI-lifecycle objects in Fragment scope" \
  --label "enhancement" \
  --body "## Problem

Injecting UI-lifecycle-dependent objects (RecyclerView.Adapter, View) using fragment scope causes memory leaks because scoped instances hold view references after \`onDestroyView\`.

## Detection Pattern

\`\`\`kotlin
scope<MyFragment> {
    scoped { MyAdapter() }  // ❌ Holds view references after onDestroyView
}
\`\`\`

## Related Koin Issues
- https://github.com/InsertKoinIO/koin/issues/1144
- https://github.com/InsertKoinIO/koin/issues/1122
- https://github.com/InsertKoinIO/koin/issues/149

## Implementation Notes
Requires Android platform type detection (Adapter, View subclasses). Consider heuristic name matching as fallback."
```

**Step 3: Create issue — CircularGetDependency**

Only if no existing issue found:

```bash
gh issue create \
  --repo androidbroadcast/Koin-Detekt \
  --title "Enhancement: CircularModuleDependency — detect definition-level circular get() chains" \
  --label "enhancement" \
  --body "## Problem

The existing \`CircularModuleDependency\` rule only detects \`includes()\` cycles at module level. It does not detect circular \`get()\` chains within module lambda bodies, which cause stack overflows at runtime.

## Detection Pattern

\`\`\`kotlin
module {
    single { A(get<B>()) }
    single { B(get<A>()) }  // ❌ Stack overflow at runtime
}
\`\`\`

## Related Koin Issues
- https://github.com/InsertKoinIO/koin/issues/334
- https://github.com/InsertKoinIO/koin/issues/2041

## Implementation Notes
Requires tracking get<T>() type resolution across definitions within a module. May require semantic analysis beyond simple PSI text matching."
```

**Step 4: Create issue — MissingAndroidContextInModuleVerification**

Only if no existing issue found:

```bash
gh issue create \
  --repo androidbroadcast/Koin-Detekt \
  --title "Rule idea: MissingAndroidContextInModuleVerification — warn when checkModules() misses androidContext()" \
  --label "enhancement" \
  --body "## Problem

\`checkModules()\` / \`verify()\` fails silently when modules use \`androidContext()\` but no Android context is provided in test setup.

## Detection Pattern

\`\`\`kotlin
@Test
fun \`verify modules\`() {
    val koin = koinApplication {
        modules(appModule)  // ❌ Fails if appModule uses androidContext()
    }
    koin.checkModules()
}
\`\`\`

## Related Koin Issues
- https://github.com/InsertKoinIO/koin/issues/553

## Implementation Notes
Requires test code analysis. May be better addressed as documentation than a static analysis rule. Low priority."
```

**Step 5: Verify issues created**

```bash
gh issue list --repo androidbroadcast/Koin-Detekt --limit 10 --state open
```

Expected: 2-4 new issues visible in the list.

---

### Task 2: Remove internal artifacts from git

**Files:**
- Delete: `pr-review-response.md`
- Delete: `docs/edge-cases-task7-completed.md`
- Delete: `docs/future-rule-ideas.md`
- Delete: `docs/plans/` (all files)

**Step 1: Remove files from git**

```bash
cd /Users/krozov/dev/projects/detekt-koin

git rm pr-review-response.md
git rm docs/edge-cases-task7-completed.md
git rm docs/future-rule-ideas.md
git rm -r docs/plans/
```

Expected output: each file shows `rm 'filename'`.

**Step 2: Verify staging area**

```bash
git status
```

Expected: all removed files show as `deleted:` in the staged changes. No unintended files removed.

**Step 3: Commit**

```bash
git commit -m "$(cat <<'EOF'
chore: remove internal development artifacts

- pr-review-response.md: one-time PR review response
- docs/edge-cases-task7-completed.md: internal task artifact
- docs/future-rule-ideas.md: migrated to GitHub Issues
- docs/plans/: internal development plans (23 files)

Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>
EOF
)"
```

---

### Task 3: Update .gitignore to exclude docs/plans/

**Files:**
- Modify: `.gitignore`

**Context:** Currently `.gitignore` doesn't explicitly exclude `docs/plans/`. Adding it prevents accidental commits of future plan files.

**Step 1: Read current .gitignore**

Read `/Users/krozov/dev/projects/detekt-koin/.gitignore` to find the right place to insert.

**Step 2: Add docs/plans/ to .gitignore**

Find the section with `# Claude Code / Agent artifacts` comment. Add after the `.worktrees/` line:

```
# AI agent development plans
docs/plans/
```

**Step 3: Verify**

```bash
cd /Users/krozov/dev/projects/detekt-koin
git check-ignore -v docs/plans/some-file.md
```

Expected: shows `.gitignore:NN:docs/plans/	docs/plans/some-file.md`

**Step 4: Commit**

```bash
git add .gitignore
git commit -m "$(cat <<'EOF'
chore: ignore docs/plans/ directory

AI agent development plans are internal artifacts
and should not be committed to the repository.

Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>
EOF
)"
```

---

### Task 4: Add README auto-update step to release pipeline

**Files:**
- Modify: `.github/workflows/release.yml`

**Context:** The `release` job currently has a step "Update and commit CHANGELOG to main" (around line 369). We add a similar step immediately after it to update the README installation snippet version.

The pattern reuses the same `git config` + `git checkout main` + idempotency check pattern from the CHANGELOG step.

**Step 1: Read the current release.yml**

Read `.github/workflows/release.yml` to find the exact line number of:
```yaml
      - name: Update and commit CHANGELOG to main
```

Note the line number — the new step goes after the entire CHANGELOG block (after the closing of that step's `run:` block).

**Step 2: Add the new step after the CHANGELOG step**

Find the block ending with:
```yaml
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
          fi
```
(this is the last line of the CHANGELOG step's `run:` block)

Insert a new step immediately after:

```yaml
      - name: Update README version on main
        continue-on-error: true
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main

          # Idempotency: skip if README already shows this version
          if grep -q "detekt-koin4-rules:${VERSION}" README.md; then
            echo "README already shows version ${VERSION}, skipping"
            exit 0
          fi

          sed -i "s/detekt-koin4-rules:[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*/detekt-koin4-rules:${VERSION}/g" README.md

          git add README.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update README installation version to ${VERSION}"
            git push origin main
            echo "✅ README updated to version ${VERSION}"
          fi
```

**Step 3: Validate YAML syntax**

```bash
cd /Users/krozov/dev/projects/detekt-koin
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))" && echo "✅ YAML valid"
```

Expected: `✅ YAML valid` with no errors.

**Step 4: Verify the step appears in the right place**

```bash
grep -n "Update README\|Update and commit CHANGELOG\|Release summary" .github/workflows/release.yml
```

Expected output (order matters):
```
369:      - name: Update and commit CHANGELOG to main
4XX:      - name: Update README version on main
4XX:      - name: Release summary
```

The README step must appear AFTER CHANGELOG and BEFORE "Release summary".

**Step 5: Commit**

```bash
git add .github/workflows/release.yml
git commit -m "$(cat <<'EOF'
ci: auto-update README installation version on release

After publishing a new version, the release pipeline now automatically
updates the installation snippet in README.md and commits it to main.

Mirrors the existing CHANGELOG update pattern with idempotency check
and continue-on-error to avoid blocking the release on doc updates.

Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>
EOF
)"
```

---

### Task 5: Final verification

**Step 1: Confirm clean git status**

```bash
cd /Users/krozov/dev/projects/detekt-koin
git status
git log --oneline -6
```

Expected: clean working tree, 4 commits visible from this work session.

**Step 2: Confirm removed files are gone**

```bash
ls pr-review-response.md 2>/dev/null && echo "❌ still exists" || echo "✅ removed"
ls docs/plans/ 2>/dev/null && echo "❌ still exists" || echo "✅ removed"
ls docs/future-rule-ideas.md 2>/dev/null && echo "❌ still exists" || echo "✅ removed"
```

Expected: all three print `✅ removed`.

**Step 3: Confirm release.yml has the new step**

```bash
grep -c "Update README version on main" .github/workflows/release.yml
```

Expected: `1`

**Step 4: Confirm .gitignore covers docs/plans/**

```bash
echo "docs/plans/test.md" | git check-ignore --stdin
```

Expected: `docs/plans/test.md`
