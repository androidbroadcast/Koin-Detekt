name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write  # Create releases, commit CHANGELOG
  packages: write  # Publish to GitHub Packages

jobs:
  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    outputs:
      is_prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $TAG_VERSION"

      - name: Validate version format
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if ! [[ $TAG_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $TAG_VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 1.0.0, 1.0.0-alpha.1)"
            exit 1
          fi
          echo "✅ Version format valid: $TAG_VERSION"

      - name: Check if pre-release
        id: prerelease
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if [[ $TAG_VERSION =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "✅ Detected pre-release version"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "✅ Detected stable release version"
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Build with Gradle
        run: ./gradlew build --no-daemon --configuration-cache -Pversion=${{ steps.version.outputs.version }}

      - name: Generate all JARs
        run: ./gradlew jar sourcesJar javadocJar --no-daemon -Pversion=${{ steps.version.outputs.version }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/*.jar
          retention-days: 1
          if-no-files-found: error

  publish:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

      - name: Generate checksums
        id: checksums
        run: |
          cd build/libs
          echo "Generating SHA-256 and SHA-512 checksums..."
          for file in *.jar; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
              sha512sum "$file" > "$file.sha512"
              echo "✅ Generated checksums for $file"
            fi
          done

          echo "Verifying checksums..."
          ls -lh *.sha*

          echo "Sample checksum:"
          head -1 *.sha256

      - name: Publish to GitHub Packages
        continue-on-error: true
        run: ./gradlew publish --no-daemon -Pversion=${{ needs.build.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Upload checksums as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: |
            build/libs/*.sha256
            build/libs/*.sha512
          retention-days: 1
          if-no-files-found: error

  publish-maven-central:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: build
    # Only publish on non-pre-release tags
    if: needs.build.outputs.is_prerelease == 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Publish to Maven Central
        run: |
          echo "Publishing version ${{ needs.build.outputs.version }} to Maven Central..."
          export SIGNING_KEY=$(echo "${{ secrets.SIGNING_KEY }}" | base64 -d)
          ./gradlew publishAllPublicationsToCentralPortal \
            --no-daemon \
            -Pversion=${{ needs.build.outputs.version }}
        env:
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      - name: Maven Central publication summary
        run: |
          echo "## Maven Central Publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Published version ${{ needs.build.outputs.version }} to Maven Central" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact coordinates:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "dev.androidbroadcast.rules.koin:detekt-koin4-rules:${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Artifacts will be available on Maven Central within 15-30 minutes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check availability: https://repo1.maven.org/maven2/dev/androidbroadcast/rules/koin/detekt-koin4-rules/" >> $GITHUB_STEP_SUMMARY

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, publish, publish-maven-central]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for CHANGELOG

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: artifacts/

      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: checksums
          path: artifacts/

      - name: Verify all artifacts present
        run: |
          echo "Checking artifacts directory..."
          ls -lh artifacts/

          JAR_COUNT=$(find artifacts/ -name "*.jar" | wc -l)
          CHECKSUM_COUNT=$(find artifacts/ -name "*.sha*" | wc -l)

          echo "Found $JAR_COUNT JAR files"
          echo "Found $CHECKSUM_COUNT checksum files"

          if [ "$JAR_COUNT" -lt 3 ]; then
            echo "::error::Expected at least 3 JAR files (main, sources, javadoc)"
            exit 1
          fi

          if [ "$CHECKSUM_COUNT" -lt 6 ]; then
            echo "::error::Expected at least 6 checksum files (SHA-256 and SHA-512 for each JAR)"
            exit 1
          fi

          echo "✅ All artifacts present"

      - name: Gather release context
        id: context
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          TAG="${GITHUB_REF#refs/tags/}"

          # Find the previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${TAG}$" | head -1)
          echo "Current tag: $TAG"
          echo "Previous tag: $PREV_TAG"
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

          if [ -n "$PREV_TAG" ]; then
            git log "${PREV_TAG}..${TAG}" --pretty=format:"%h %s" --no-merges > /tmp/commits.txt
            git diff "${PREV_TAG}..${TAG}" --stat > /tmp/diffstat.txt
          else
            git log --pretty=format:"%h %s" --no-merges > /tmp/commits.txt
            git diff --stat > /tmp/diffstat.txt || true
          fi

          echo "Commits since $PREV_TAG:"
          cat /tmp/commits.txt
          echo ""
          echo "Diff stat:"
          cat /tmp/diffstat.txt

      - name: Generate release notes via Claude
        id: release_notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          TAG="${GITHUB_REF#refs/tags/}"
          PREV_TAG="${{ steps.context.outputs.prev_tag }}"
          REPO="${{ github.repository }}"

          COMMITS=$(cat /tmp/commits.txt)
          DIFFSTAT=$(cat /tmp/diffstat.txt)

          SYSTEM_PROMPT='You generate concise, well-structured release notes for a Kotlin detekt plugin library (detekt-koin4-rules). Output Markdown only, no wrapping code fences.

          Structure:
          1. One-sentence summary of the release
          2. Categorized changes using these headings (skip empty categories):
             ### New Rules
             ### Bug Fixes
             ### Improvements
             ### Documentation
             ### Infrastructure
          3. Installation snippet:
             ```kotlin
             dependencies {
                 detektPlugins("dev.androidbroadcast.rules.koin:detekt-koin4-rules:VERSION")
             }
             ```
          4. **Full Changelog**: link to GitHub compare URL

          Rules:
          - Derive categories from conventional commit prefixes (feat:, fix:, docs:, ci:, refactor:, perf:, test:)
          - Use bullet points with brief descriptions
          - Do NOT invent changes not present in the commit list
          - Keep it concise: prefer one line per change'

          USER_MSG="Generate release notes for v${VERSION}.

          Commits since ${PREV_TAG}:
          ${COMMITS}

          Diff stats:
          ${DIFFSTAT}

          Repository: ${REPO}
          Previous tag: ${PREV_TAG}
          Current tag: ${TAG}"

          # Build JSON payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg model "claude-sonnet-4-20250514" \
            --arg system "$SYSTEM_PROMPT" \
            --arg user "$USER_MSG" \
            '{
              model: $model,
              max_tokens: 2048,
              system: $system,
              messages: [{role: "user", content: $user}]
            }')

          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/claude_response.json \
            https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d "$PAYLOAD")

          if [ "$HTTP_CODE" -eq 200 ]; then
            jq -r '.content[0].text' /tmp/claude_response.json > /tmp/release_notes.md
            echo "✅ Release notes generated via Claude API"
          else
            echo "::warning::Claude API returned HTTP $HTTP_CODE, using fallback release notes"
            cat /tmp/claude_response.json || true
            {
              echo "## What's Changed"
              echo ""
              while IFS= read -r line; do
                echo "* ${line}"
              done < /tmp/commits.txt
              echo ""
              if [ -n "$PREV_TAG" ]; then
                echo "**Full Changelog**: https://github.com/${REPO}/compare/${PREV_TAG}...${TAG}"
              fi
            } > /tmp/release_notes.md
            echo "⚠️ Fallback release notes generated from commit list"
          fi

          echo "--- Generated release notes ---"
          cat /tmp/release_notes.md

      - name: Create Draft Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: ${{ needs.build.outputs.is_prerelease }}
          generate_release_notes: false
          body_path: /tmp/release_notes.md
          files: |
            artifacts/*.jar
            artifacts/*.sha256
            artifacts/*.sha512
          fail_on_unmatched_files: true
          name: Release ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update and commit CHANGELOG to main
        id: changelog_commit
        continue-on-error: true
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main

          # Idempotency: skip if this version is already in CHANGELOG
          if grep -q "^## v${VERSION} " CHANGELOG.md; then
            echo "Version v${VERSION} already in CHANGELOG.md, skipping"
            echo "changelog_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build the new release section
          SECTION_FILE="$(mktemp)"
          {
            echo ""
            echo "## v${VERSION} - $(date +%Y-%m-%d)"
            echo ""
            cat /tmp/release_notes.md
            echo ""
          } > "$SECTION_FILE"

          # Insert after ## [Unreleased], or after # Changelog if no Unreleased section
          if grep -q '^\## \[Unreleased\]' CHANGELOG.md; then
            sed '/^## \[Unreleased\]/r '"$SECTION_FILE"'' CHANGELOG.md > new_changelog.md
          else
            sed '/^# Changelog/r '"$SECTION_FILE"'' CHANGELOG.md > new_changelog.md
          fi

          mv new_changelog.md CHANGELOG.md
          rm "$SECTION_FILE"

          echo "CHANGELOG.md updated:"
          head -30 CHANGELOG.md

          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changelog_updated=false" >> $GITHUB_OUTPUT
          else
            git commit -m "docs: update CHANGELOG for v${VERSION}"
            git push origin main
            echo "✅ CHANGELOG committed to main"
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Update README version on main
        continue-on-error: true
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main

          # Idempotency: skip if README already shows this version
          if grep -q "detekt-koin4-rules:${VERSION}" README.md; then
            echo "README already shows version ${VERSION}, skipping"
            exit 0
          fi

          sed -i'' "s/detekt-koin4-rules:[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*/detekt-koin4-rules:${VERSION}/g" README.md

          git pull --rebase origin main
          git add README.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update README installation version to ${VERSION}"
            git push origin main
            echo "README updated to version ${VERSION}"
          fi

      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ needs.build.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: ${{ steps.create_release.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the draft release at the URL above" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all artifacts are attached" >> $GITHUB_STEP_SUMMARY
          echo "3. Click 'Publish release' to make it public" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify Maven Central publication (available in 15-30 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changelog_commit.outputs.changelog_updated }}" == "true" ]; then
            echo "CHANGELOG.md has been updated in the main branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "CHANGELOG.md update was skipped or failed (check logs above)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Release workflow failed for ${{ github.ref_name }}"
          echo "## Release Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
