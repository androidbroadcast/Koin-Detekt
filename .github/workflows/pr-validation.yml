name: PR Validation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, 'feature/**' ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  validate:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: Build with Gradle
        run: ./gradlew build --no-daemon --configuration-cache

      - name: Verify reproducible builds
        run: |
          echo "Building first time..."
          ./gradlew clean jar --no-daemon
          sha256sum build/libs/detekt-rules-koin-*.jar > /tmp/build1.sha256

          echo "Building second time..."
          ./gradlew clean jar --no-daemon
          sha256sum build/libs/detekt-rules-koin-*.jar > /tmp/build2.sha256

          echo "Comparing checksums..."
          if diff /tmp/build1.sha256 /tmp/build2.sha256; then
            echo "✅ Builds are reproducible"
          else
            echo "❌ Builds are not reproducible"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/
          retention-days: 7

      - name: Upload build reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: build/reports/
          retention-days: 7

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Check explicit API mode
        run: ./gradlew compileKotlin --no-daemon --warning-mode=all

      - name: Verify no warnings
        run: |
          if ./gradlew compileKotlin --no-daemon --warning-mode=all 2>&1 | grep -i "warning"; then
            echo "❌ Compilation warnings found"
            exit 1
          else
            echo "✅ No compilation warnings"
          fi

  maven-publication:
    name: Validate Maven Publication
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Generate POM
        run: ./gradlew generatePomFileForMavenPublication --no-daemon

      - name: Validate POM contents
        run: |
          POM_FILE="build/publications/maven/pom-default.xml"

          echo "Checking POM metadata..."

          if ! grep -q "<name>detekt-rules-koin</name>" "$POM_FILE"; then
            echo "❌ Missing project name in POM"
            exit 1
          fi

          if ! grep -q "<description>" "$POM_FILE"; then
            echo "❌ Missing description in POM"
            exit 1
          fi

          if ! grep -q "<license>" "$POM_FILE"; then
            echo "❌ Missing license in POM"
            exit 1
          fi

          if ! grep -q "<developer>" "$POM_FILE"; then
            echo "❌ Missing developer in POM"
            exit 1
          fi

          if ! grep -q "<scm>" "$POM_FILE"; then
            echo "❌ Missing SCM in POM"
            exit 1
          fi

          echo "✅ POM validation successful"

      - name: Build all artifacts
        run: ./gradlew publishToMavenLocal --no-daemon

      - name: Verify artifacts
        run: |
          ARTIFACTS_DIR="$HOME/.m2/repository/io/github/krozov/detekt-rules-koin/0.1.0-SNAPSHOT"

          echo "Checking for required artifacts..."

          if [ ! -f "$ARTIFACTS_DIR/detekt-rules-koin-0.1.0-SNAPSHOT.jar" ]; then
            echo "❌ Main JAR not found"
            exit 1
          fi

          if [ ! -f "$ARTIFACTS_DIR/detekt-rules-koin-0.1.0-SNAPSHOT-sources.jar" ]; then
            echo "❌ Sources JAR not found"
            exit 1
          fi

          if [ ! -f "$ARTIFACTS_DIR/detekt-rules-koin-0.1.0-SNAPSHOT-javadoc.jar" ]; then
            echo "❌ Javadoc JAR not found"
            exit 1
          fi

          echo "✅ All artifacts generated successfully"

          echo "Artifact sizes:"
          ls -lh "$ARTIFACTS_DIR"/*.jar
