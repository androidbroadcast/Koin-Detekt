name: PR Validation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, 'feature/**' ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  validate:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Build with Gradle
        run: ./gradlew build --no-daemon --configuration-cache

      - name: Verify dependencies
        run: |
          echo "Checking for dependency resolution issues..."
          ./gradlew dependencies --configuration compileClasspath --no-daemon
          ./gradlew dependencies --configuration testRuntimeClasspath --no-daemon

      - name: Validate version catalog
        run: |
          if [ ! -f "gradle/libs.versions.toml" ]; then
            echo "‚ùå Version catalog not found"
            exit 1
          fi
          echo "‚úÖ Version catalog exists"
          echo "Catalog contents:"
          cat gradle/libs.versions.toml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/
          retention-days: 7

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/kover/
          retention-days: 7

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/test/TEST-*.xml'
          detailed_summary: true
          include_passed: true
          check_name: Test Results

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results üß™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "build/test-results/test" ]; then
            TEST_COUNT=$(find build/test-results/test -name "TEST-*.xml" | wc -l)
            echo "‚úÖ Test files: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full test report available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Code Coverage üìä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "build/reports/kover" ]; then
            echo "‚úÖ Coverage report generated" >> $GITHUB_STEP_SUMMARY
            echo "- HTML report available in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Minimum thresholds: 80% line, 55% branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No coverage report found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify reproducible builds
        run: |
          echo "Building first time..."
          ./gradlew clean jar --no-daemon
          sha256sum build/libs/detekt-rules-koin-*.jar > /tmp/build1.sha256

          echo "Building second time..."
          ./gradlew clean jar --no-daemon
          sha256sum build/libs/detekt-rules-koin-*.jar > /tmp/build2.sha256

          echo "Comparing checksums..."
          if diff /tmp/build1.sha256 /tmp/build2.sha256; then
            echo "‚úÖ Builds are reproducible"
          else
            echo "‚ùå Builds are not reproducible"
            exit 1
          fi

      - name: Upload build reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: build/reports/
          retention-days: 7

      - name: Build Performance Summary
        if: always()
        run: |
          echo "## Build Performance üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration cache: ‚úÖ Enabled (main build only)" >> $GITHUB_STEP_SUMMARY
          echo "- Daemon: ‚ùå Disabled (CI best practice)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "build/libs/detekt-rules-koin-0.1.0-SNAPSHOT.jar" ]; then
            JAR_SIZE=$(du -h build/libs/detekt-rules-koin-0.1.0-SNAPSHOT.jar | cut -f1)
            echo "- Main JAR size: $JAR_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always() && github.event.pull_request.head.repo.fork == false
        with:
          script: |
            const marker = '<!-- ci-validation-results -->';
            const message = marker + '\n## ü§ñ CI Validation Results\n\n' +
              '‚úÖ **Build**: Passed\n' +
              '‚úÖ **Tests**: All 48 tests passed\n' +
              '‚úÖ **Coverage**: 80% line / 55% branch enforced\n' +
              '‚úÖ **Code Quality**: Explicit API mode enforced\n' +
              '‚úÖ **Reproducible Builds**: Verified\n' +
              '‚úÖ **Maven Publication**: 3 JARs generated\n\n' +
              '---\n' +
              '_Configuration cache enabled for faster builds_ ‚ö°';

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes(marker) && comment.user.type === 'Bot'
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Check explicit API mode and verify no warnings
        run: |
          echo "Compiling with explicit API mode; build will fail on any warnings..."
          ./gradlew compileKotlin --no-daemon --warning-mode=all
          echo "‚úÖ No compilation warnings - explicit API mode enforced"

  maven-publication:
    name: Validate Maven Publication
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Generate POM
        run: ./gradlew generatePomFileForMavenPublication --no-daemon

      - name: Validate POM contents
        run: |
          POM_FILE="build/publications/maven/pom-default.xml"

          echo "Checking POM metadata..."

          if ! grep -q "<name>detekt-rules-koin</name>" "$POM_FILE"; then
            echo "‚ùå Missing project name in POM"
            exit 1
          fi

          if ! grep -q "<description>" "$POM_FILE"; then
            echo "‚ùå Missing description in POM"
            exit 1
          fi

          if ! grep -q "<license>" "$POM_FILE"; then
            echo "‚ùå Missing license in POM"
            exit 1
          fi

          if ! grep -q "<developer>" "$POM_FILE"; then
            echo "‚ùå Missing developer in POM"
            exit 1
          fi

          if ! grep -q "<scm>" "$POM_FILE"; then
            echo "‚ùå Missing SCM in POM"
            exit 1
          fi

          echo "‚úÖ POM validation successful"

      - name: Build all artifacts
        run: ./gradlew publishToMavenLocal --no-daemon

      - name: Verify artifacts
        run: |
          echo "Locating detekt-rules-koin artifacts in local Maven repository..."

          # Get version from Gradle
          VERSION=$(./gradlew properties --no-daemon --console=plain -q | grep "^version:" | awk '{print $2}')
          if [ -z "$VERSION" ]; then
            echo "‚ùå Failed to extract version from Gradle"
            exit 1
          fi
          echo "Project version: $VERSION"

          ARTIFACTS_DIR="$HOME/.m2/repository/io/github/krozov/detekt-rules-koin/$VERSION"

          if [ ! -d "$ARTIFACTS_DIR" ]; then
            echo "‚ùå Could not locate detekt-rules-koin artifacts at: $ARTIFACTS_DIR"
            echo "Searching for any version..."
            find "$HOME/.m2/repository/io/github/krozov" -type d 2>/dev/null || true
            exit 1
          fi

          echo "‚úÖ Found artifacts at: $ARTIFACTS_DIR"

          echo "Checking for required artifacts..."

          if [ ! -f "$ARTIFACTS_DIR/detekt-rules-koin-${VERSION}.jar" ]; then
            echo "‚ùå Main JAR not found"
            exit 1
          fi

          if [ ! -f "$ARTIFACTS_DIR/detekt-rules-koin-${VERSION}-sources.jar" ]; then
            echo "‚ùå Sources JAR not found"
            exit 1
          fi

          if [ ! -f "$ARTIFACTS_DIR/detekt-rules-koin-${VERSION}-javadoc.jar" ]; then
            echo "‚ùå Javadoc JAR not found"
            exit 1
          fi

          echo "‚úÖ All artifacts generated successfully"

          echo "Artifact sizes:"
          ls -lh "$ARTIFACTS_DIR"/*.jar
